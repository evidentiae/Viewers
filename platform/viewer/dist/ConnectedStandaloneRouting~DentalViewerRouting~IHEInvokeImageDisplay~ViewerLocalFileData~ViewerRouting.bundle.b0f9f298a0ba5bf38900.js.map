{"version":3,"sources":["webpack:///./connectedComponents/ConnectedCineDialog.js","webpack:///./connectedComponents/ConnectedLayoutButton.js","webpack:///./connectedComponents/ToolbarRow.js","webpack:///./connectedComponents/ConnectedStudyBrowser.js","webpack:///./components/DentalGrid/ViewportPane.js","webpack:///./components/DentalGrid/ViewportGrid.js","webpack:///./components/DentalGrid/DefaultViewport.js","webpack:///./components/DentalGrid/ConnectedViewportGrid.js","webpack:///./connectedComponents/ViewerMain.js","webpack:///./connectedComponents/ConnectedViewerMain.js","webpack:///./components/SidePanel.js","webpack:///./components/ErrorBoundaryDialog/ErrorBoundaryDialog.js","webpack:///./components/ErrorBoundaryDialog/index.js","webpack:///./components/LayoutPickerDialog/LayoutPickerDialog.js","webpack:///./components/LayoutPickerDialog/index.js","webpack:///./connectedComponents/Viewer.js","webpack:///./connectedComponents/ConnectedViewer.js"],"names":["scrollToIndex","toolImport","csTools","import","setViewportSpecificData","OHIF","redux","actions","ConnectedCineDialog","connect","state","viewports","cine","viewportSpecificData","activeViewportIndex","activeEnabledElement","commandsManager","runCommand","activeViewportCineData","isPlaying","cineFrameRate","dispatch","dispatchSetViewportSpecificData","viewportIndex","data","propsFromState","propsFromDispatch","ownProps","onPlayPauseChanged","cloneDeep","onFrameRateChanged","frameRate","onClickNextButton","stackData","getToolState","length","currentImageIdIndex","imageIds","onClickBackButton","onClickSkipToStart","onClickSkipToEnd","lastIndex","CineDialog","setLayout","setViewportActive","currentLayout","layout","onChange","selectedCell","numRows","row","numColumns","col","numViewports","i","viewport","plugin","vtk","push","onChangeFromDispatch","LayoutButton","ToolbarRow","props","dialog","dialogId","activeButtons","toolbarButtons","find","button","options","behavior","dismiss","id","filter","setState","toolbarButtonDefinitions","_getVisibleToolbarButtons","call","seriesPerStudyCount","_handleBuiltIn","bind","updateButtonGroups","panelModules","extensionManager","modules","MODULE_TYPES","PANEL","this","buttonGroups","left","right","forEach","panelExtension","panelModule","module","defaultContexts","Array","from","defaultContext","menuOptions","menuOption","contexts","context","hasActiveContext","activeContexts","some","actx","includes","isDisabled","studies","activeViewport","menuOptionEntry","value","target","icon","bottomLabel","label","unshift","t","prevProps","activeContextsChanged","prevStudies","prevActiveViewport","shouldUpdate","series","closeCineDialogIfNotApplicable","buttonComponents","_getButtonComponents","onPress","side","handleSidePanelChange","onPressLeft","onPressRight","className","style","padding","selectedLeftSidePanel","onValueChanged","isActive","onClick","handleNewStudy","maximized","handleMaximize","handleUpload","marginLeft","selectedRightSidePanel","Component","_getCustomButtonComponent","CustomComponent","activeButtonsIds","map","parentContext","toolbarClickCallback","_handleToolbarButtonClick","key","_getExpandableButtonComponent","activeCommand","childButtons","buttons","childButton","indexOf","_getDefaultButtonComponent","_this","hasCustomComponent","hasNestedButtonDefinitions","evt","commandName","Object","assign","commandOptions","type","toggables","togglable","toolbarModules","TOOLBAR","extension","definitions","definition","document","querySelector","getBoundingClientRect","x","y","newDialogId","create","content","defaultPosition","title","isLeftSidePanelOpen","PropTypes","bool","isRequired","isRightSidePanelOpen","string","func","arrayOf","array","any","modal","withTranslation","withModal","withDialog","withAppContext","utils","studyMetadataManager","setViewportLayoutAndData","clearViewportSpecificData","setActiveViewportSpecificData","ConnectedStudyBrowser","stackLoadingProgressMap","loading","progress","studiesWithLoadingData","study","thumbnails","displaySetInstanceUID","stackId","stackProgressData","stackPercentComplete","percentComplete","onThumbnailClick","seriesInstanceUID","console","log","studyMetadata","displaySets","numFrames","j","set","SeriesInstanceUID","Maximized","StudyBrowser","ViewportPane","children","onDrop","propClassName","useDrop","accept","drop","droppedItem","monitor","canDrop","isOver","StudyInstanceUID","collect","highlighted","hovered","classNames","ref","data-cy","ev","propTypes","node","number","loadAndCacheDerivedDisplaySets","ViewportGrid","availablePlugins","defaultPluginName","defaultPlugin","setViewportData","viewportData","isStudyLoaded","onSetActiveViewport","effectiveNumRows","effectiveNumColumns","rowSize","colSize","snackbar","useSnackbarContext","useEffect","displaySet","promise","catch","error","show","message","autoClose","getMaximizedViewportPane","frameIndex","pluginName","ViewportComponent","_getViewportComponent","active","ViewportPanes","idx","getViewportPane","display","gridTemplateRows","gridTemplateColumns","height","width","Error","JSON","stringify","supportsDrop","object","defaultProps","DefaultViewport","getAvailableViewportModules","memoize","viewportModules","availableViewportModules","moduleDefinition","extensionId","ConnectedViewportGrid","VIEWPORT","index","values","_values","ViewerMain","dirtyViewportPanes","viewportPane","foundDisplaySet","ds","v","vp","findDisplaySet","isDerived","Modality","getSourceDisplaySet","seriesNumber","SeriesNumber","dSet","getDisplaySets","fillEmptyViewportPanes","prevViewportAmount","viewportAmount","isVtk","keys","ConnectedViewerMain","SidePanel","isOpen","fromSideClass","styles","maxWidth","marginRight","Number","parseInt","UIModalService","servicesManager","services","ErrorBoundaryDialog","fallbackComponent","role","onError","componentStack","useState","open","setOpen","s","name","classnames","opened","LayoutPickerDialog","onCancel","e","preventDefault","pick","layouts","onConfirm","SimpleDialog","headerTitle","onClose","rootClass","headless","itemClass","itemMetaClass","onItemClick","dcmjs","DicomMetaDictionary","DicomDict","guid","Viewer","isSelectingLayout","info","earliestDate","Date","toISOString","latestDate","StudyDate","moment","Promise","resolve","timepointType","timepointId","studyInstanceUIDs","PatientID","isLocked","timepointData","query","timepointIds","timepoints","onTimepointsUpdated","measurements","onMeasurementsUpdated","activeServer","server","MeasurementApi","setConfiguration","dataExchange","retrieve","DICOMSR","retrieveMeasurements","store","storeMeasurements","TimepointApi","retrieveTimepoints","storeTimepoints","remove","removeTimepoint","update","updateTimepoint","disassociate","disassociateStudy","_getActiveViewport","dismissAll","timepointApi","measurementApi","currentTimepointId","_mapStudiesToThumbnails","url","token","window","access_token","headers","Authorization","api","DICOMwebClient","fileMetaInformationVersionArray","Uint8Array","metadata","Value","buffer","vr","uid","dict","SOPInstanceUID","SOPClassUID","ImageBoxes","upsertTag","patientID","write","wadoRoot","client","getClient","storeInstances","datasets","then","result","onNewStudy","self","loadImage","imageData","createNewImageInstance","onSuccess","input","createElement","setAttribute","onchange","file","files","reader","FileReader","onerror","onload","image","src","decode","naturalWidth","naturalHeight","canvas","ctx","getContext","drawImage","getImageData","err","readAsDataURL","body","appendChild","click","removeChild","toString","pixels","VisiblePanelLeft","VisiblePanelRight","panelExt","components","comp","component","createNewStudy","selectedPanel","sideClicked","toUpperCase","slice","openKey","selectedKey","updatedState","prevSelectedPanel","isSameSelectedPanel","onMaximize","uploadImage","activeIndex","getActiveViewport","shape","SeriesDescription","InstanceNumber","numImageFrames","images","getImageId","undefined","imageId","altImageText","imageIndex","Math","floor","setTimepoints","setMeasurements","maximize","setStudyData","getActiveServer","servers","a","ConnectedViewer"],"mappings":"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","file":"ConnectedStandaloneRouting~DentalViewerRouting~IHEInvokeImageDisplay~ViewerLocalFileData~ViewerRouting.bundle.b0f9f298a0ba5bf38900.js","sourcesContent":["import { connect } from 'react-redux';\nimport { CineDialog } from '@ohif/ui';\nimport OHIF from '@ohif/core';\nimport csTools from 'cornerstone-tools';\nimport { commandsManager } from './../App.js';\n// Our target output kills the `as` and \"import\" throws a keyword error\n// import { import as toolImport, getToolState } from 'cornerstone-tools';\nimport cloneDeep from 'lodash.clonedeep';\n\nconst toolImport = csTools.import;\nconst scrollToIndex = toolImport('util/scrollToIndex');\nconst { setViewportSpecificData } = OHIF.redux.actions;\n\n// Why do I need or care about any of this info?\n// A dispatch action should be able to pull this at the time of an event?\n// `isPlaying` and `cineFrameRate` might matter, but I think we can prop pass for those.\nconst mapStateToProps = state => {\n  // Get activeViewport's `cine` and `stack`\n  const { viewportSpecificData, activeViewportIndex } = state.viewports;\n  const { cine } = viewportSpecificData[activeViewportIndex] || {};\n  const dom = commandsManager.runCommand('getActiveViewportEnabledElement');\n\n  const cineData = cine || {\n    isPlaying: false,\n    cineFrameRate: 24,\n  };\n\n  // New props we're creating?\n  return {\n    activeEnabledElement: dom,\n    activeViewportCineData: cineData,\n    activeViewportIndex: state.viewports.activeViewportIndex,\n  };\n};\n\nconst mapDispatchToProps = dispatch => {\n  return {\n    dispatchSetViewportSpecificData: (viewportIndex, data) => {\n      dispatch(setViewportSpecificData(viewportIndex, data));\n    },\n  };\n};\n\nconst mergeProps = (propsFromState, propsFromDispatch, ownProps) => {\n  const {\n    activeEnabledElement,\n    activeViewportCineData,\n    activeViewportIndex,\n  } = propsFromState;\n\n  return {\n    cineFrameRate: activeViewportCineData.cineFrameRate,\n    isPlaying: activeViewportCineData.isPlaying,\n    onPlayPauseChanged: isPlaying => {\n      const cine = cloneDeep(activeViewportCineData);\n      cine.isPlaying = !cine.isPlaying;\n\n      propsFromDispatch.dispatchSetViewportSpecificData(activeViewportIndex, {\n        cine,\n      });\n    },\n    onFrameRateChanged: frameRate => {\n      const cine = cloneDeep(activeViewportCineData);\n      cine.cineFrameRate = frameRate;\n\n      propsFromDispatch.dispatchSetViewportSpecificData(activeViewportIndex, {\n        cine,\n      });\n    },\n    onClickNextButton: () => {\n      const stackData = csTools.getToolState(activeEnabledElement, 'stack');\n      if (!stackData || !stackData.data || !stackData.data.length) return;\n      const { currentImageIdIndex, imageIds } = stackData.data[0];\n      if (currentImageIdIndex >= imageIds.length - 1) return;\n      scrollToIndex(activeEnabledElement, currentImageIdIndex + 1);\n    },\n    onClickBackButton: () => {\n      const stackData = csTools.getToolState(activeEnabledElement, 'stack');\n      if (!stackData || !stackData.data || !stackData.data.length) return;\n      const { currentImageIdIndex } = stackData.data[0];\n      if (currentImageIdIndex === 0) return;\n      scrollToIndex(activeEnabledElement, currentImageIdIndex - 1);\n    },\n    onClickSkipToStart: () => {\n      const stackData = csTools.getToolState(activeEnabledElement, 'stack');\n      if (!stackData || !stackData.data || !stackData.data.length) return;\n      scrollToIndex(activeEnabledElement, 0);\n    },\n    onClickSkipToEnd: () => {\n      const stackData = csTools.getToolState(activeEnabledElement, 'stack');\n      if (!stackData || !stackData.data || !stackData.data.length) return;\n      const lastIndex = stackData.data[0].imageIds.length - 1;\n      scrollToIndex(activeEnabledElement, lastIndex);\n    },\n  };\n};\n\nconst ConnectedCineDialog = connect(\n  mapStateToProps,\n  mapDispatchToProps,\n  mergeProps\n)(CineDialog);\n\nexport default ConnectedCineDialog;\n","import { LayoutButton } from '@ohif/ui';\nimport OHIF from '@ohif/core';\nimport { connect } from 'react-redux';\n\nconst { setLayout, setViewportActive } = OHIF.redux.actions;\n\nconst mapStateToProps = state => {\n  return {\n    currentLayout: state.viewports.layout,\n    activeViewportIndex: state.viewports.activeViewportIndex,\n  };\n};\n\nconst mapDispatchToProps = dispatch => {\n  return {\n    // TODO: Change if layout switched becomes more complex\n    onChange: (selectedCell, currentLayout, activeViewportIndex) => {\n      const viewports = [];\n      const numRows = selectedCell.row + 1;\n      const numColumns = selectedCell.col + 1;\n      const numViewports = numRows * numColumns;\n\n      for (let i = 0; i < numViewports; i++) {\n        // Hacky way to allow users to exit MPR \"mode\"\n        const viewport = currentLayout.viewports[i];\n        let plugin = viewport && viewport.plugin;\n        if (viewport && viewport.vtk) {\n          plugin = 'cornerstone';\n        }\n\n        viewports.push({\n          plugin,\n        });\n      }\n      const layout = {\n        numRows,\n        numColumns,\n        viewports,\n      };\n\n      const maxActiveIndex = numViewports - 1;\n      if (activeViewportIndex > maxActiveIndex) {\n        dispatch(setViewportActive(0));\n      }\n\n      dispatch(setLayout(layout));\n    },\n  };\n};\n\nconst mergeProps = (propsFromState, propsFromDispatch) => {\n  const onChangeFromDispatch = propsFromDispatch.onChange;\n  const { currentLayout, activeViewportIndex } = propsFromState;\n\n  return {\n    onChange: selectedCell =>\n      onChangeFromDispatch(selectedCell, currentLayout, activeViewportIndex),\n  };\n};\n\nconst ConnectedLayoutButton = connect(\n  mapStateToProps,\n  mapDispatchToProps,\n  mergeProps\n)(LayoutButton);\n\nexport default ConnectedLayoutButton;\n","import React, { Component } from 'react';\nimport PropTypes from 'prop-types';\nimport { withTranslation } from 'react-i18next';\n\nimport { MODULE_TYPES } from '@ohif/core';\nimport {\n  ExpandableToolMenu,\n  RoundedButtonGroup,\n  ToolbarButton,\n  withModal,\n  withDialog,\n} from '@ohif/ui';\n\nimport './ToolbarRow.css';\nimport { commandsManager, extensionManager } from './../App.js';\n\nimport ConnectedCineDialog from './ConnectedCineDialog';\nimport ConnectedLayoutButton from './ConnectedLayoutButton';\nimport { withAppContext } from '../context/AppContext';\n\nclass ToolbarRow extends Component {\n  // TODO: Simplify these? isOpen can be computed if we say \"any\" value for selected,\n  // closed if selected is null/undefined\n  static propTypes = {\n    isLeftSidePanelOpen: PropTypes.bool.isRequired,\n    isRightSidePanelOpen: PropTypes.bool.isRequired,\n    selectedLeftSidePanel: PropTypes.string.isRequired,\n    selectedRightSidePanel: PropTypes.string.isRequired,\n    handleSidePanelChange: PropTypes.func.isRequired,\n    handleMaximize: PropTypes.func.isRequired,\n    handleNewStudy: PropTypes.func.isRequired,\n    handleUpload: PropTypes.func.isRequired,\n    activeContexts: PropTypes.arrayOf(PropTypes.string).isRequired,\n    studies: PropTypes.array,\n    t: PropTypes.func.isRequired,\n    // NOTE: withDialog, withModal HOCs\n    dialog: PropTypes.any,\n    modal: PropTypes.any,\n    maximized: PropTypes.bool.isRequired\n  };\n\n  static defaultProps = {\n    studies: [],\n  };\n\n  constructor(props) {\n    super(props);\n\n    const toolbarButtonDefinitions = _getVisibleToolbarButtons.call(this);\n    // TODO:\n    // If it's a tool that can be active... Mark it as active?\n    // - Tools that are on/off?\n    // - Tools that can be bound to multiple buttons?\n\n    // Normal ToolbarButtons...\n    // Just how high do we need to hoist this state?\n    // Why ToolbarRow instead of just Toolbar? Do we have any others?\n    this.state = {\n      toolbarButtons: toolbarButtonDefinitions,\n      activeButtons: [],\n    };\n\n    this.seriesPerStudyCount = [];\n\n    this._handleBuiltIn = _handleBuiltIn.bind(this);\n\n    this.updateButtonGroups();\n  }\n\n  updateButtonGroups() {\n    const panelModules = extensionManager.modules[MODULE_TYPES.PANEL];\n\n    this.buttonGroups = {\n      left: [],\n      right: [],\n    };\n\n    // ~ FIND MENU OPTIONS\n    panelModules.forEach(panelExtension => {\n      const panelModule = panelExtension.module;\n      const defaultContexts = Array.from(panelModule.defaultContext);\n\n      panelModule.menuOptions.forEach(menuOption => {\n        const contexts = Array.from(menuOption.context || defaultContexts);\n        const hasActiveContext = this.props.activeContexts.some(actx =>\n          contexts.includes(actx)\n        );\n\n        // It's a bit beefy to pass studies; probably only need to be reactive on `studyInstanceUIDs` and activeViewport?\n        // Note: This does not cleanly handle `studies` prop updating with panel open\n        const isDisabled =\n          typeof menuOption.isDisabled === 'function' &&\n          menuOption.isDisabled(this.props.studies, this.props.activeViewport);\n\n        if (hasActiveContext && !isDisabled) {\n          const menuOptionEntry = {\n            value: menuOption.target,\n            icon: menuOption.icon,\n            bottomLabel: menuOption.label,\n          };\n          const from = menuOption.from || 'right';\n\n          this.buttonGroups[from].push(menuOptionEntry);\n        }\n      });\n    });\n\n    // TODO: This should come from extensions, instead of being baked in\n    this.buttonGroups.left.unshift({\n      value: 'studies',\n      icon: 'th-large',\n      bottomLabel: this.props.t('Series'),\n    });\n  }\n\n  componentDidUpdate(prevProps) {\n    const activeContextsChanged =\n      prevProps.activeContexts !== this.props.activeContexts;\n\n    const prevStudies = prevProps.studies;\n    const prevActiveViewport = prevProps.activeViewport;\n    const activeViewport = this.props.activeViewport;\n    const studies = this.props.studies;\n    const seriesPerStudyCount = this.seriesPerStudyCount;\n\n    let shouldUpdate = false;\n\n    if (\n      prevStudies.length !== studies.length ||\n      prevActiveViewport !== activeViewport\n    ) {\n      shouldUpdate = true;\n    } else {\n      for (let i = 0; i < studies.length; i++) {\n        if (studies[i].series.length !== seriesPerStudyCount[i]) {\n          seriesPerStudyCount[i] = studies[i].series.length;\n\n          shouldUpdate = true;\n          break;\n        }\n      }\n    }\n\n    if (shouldUpdate) {\n      this.updateButtonGroups();\n    }\n\n    if (activeContextsChanged) {\n      this.setState(\n        {\n          toolbarButtons: _getVisibleToolbarButtons.call(this),\n        },\n        this.closeCineDialogIfNotApplicable\n      );\n    }\n  }\n\n  closeCineDialogIfNotApplicable = () => {\n    const { dialog } = this.props;\n    let { dialogId, activeButtons, toolbarButtons } = this.state;\n    if (dialogId) {\n      const cineButtonPresent = toolbarButtons.find(\n        button => button.options && button.options.behavior === 'CINE'\n      );\n      if (!cineButtonPresent) {\n        dialog.dismiss({ id: dialogId });\n        activeButtons = activeButtons.filter(\n          button => button.options && button.options.behavior !== 'CINE'\n        );\n        this.setState({ dialogId: null, activeButtons });\n      }\n    }\n  };\n\n  render() {\n    const buttonComponents = _getButtonComponents.call(\n      this,\n      this.state.toolbarButtons,\n      this.state.activeButtons\n    );\n\n    const onPress = (side, value) => {\n      this.props.handleSidePanelChange(side, value);\n    };\n    const onPressLeft = onPress.bind(this, 'left');\n    const onPressRight = onPress.bind(this, 'right');\n\n    return (\n      <>\n        <div className=\"ToolbarRow\">\n          <div className=\"pull-left m-t-1 p-y-1\" style={{ padding: '10px' }}>\n            <RoundedButtonGroup\n              options={this.buttonGroups.left}\n              value={this.props.selectedLeftSidePanel || ''}\n              onValueChanged={onPressLeft}\n            />\n          </div>\n          <ToolbarButton\n            label=\"New study\"\n            icon='th'\n            isActive={true}\n            onClick={this.props.handleNewStudy}\n          />\n          {buttonComponents}\n          {this.props.studies.length > 0 &&\n            <ToolbarButton\n              label={this.props.maximized ? 'Minimize' : 'Maximize'}\n              icon='maximize'\n              isActive={this.props.studies.length > 0}\n              onClick={this.props.handleMaximize}\n            />\n          }\n          {this.props.studies.length > 0 &&\n            <ToolbarButton\n              label='Upload image'\n              icon='create-screen-capture'\n              isActive={this.props.studies.length > 0}\n              onClick={this.props.handleUpload}\n            />\n          }\n          <div\n            className=\"pull-right m-t-1 rm-x-1\"\n            style={{ marginLeft: 'auto' }}\n          >\n            {this.buttonGroups.right.length && (\n              <RoundedButtonGroup\n                options={this.buttonGroups.right}\n                value={this.props.selectedRightSidePanel || ''}\n                onValueChanged={onPressRight}\n              />\n            )}\n          </div>\n        </div>\n      </>\n    );\n  }\n}\n\nfunction _getCustomButtonComponent(button, activeButtons) {\n  const CustomComponent = button.CustomComponent;\n  const isValidComponent = typeof CustomComponent === 'function';\n\n  // Check if its a valid customComponent. Later on an CustomToolbarComponent interface could be implemented.\n  if (isValidComponent) {\n    const parentContext = this;\n    const activeButtonsIds = activeButtons.map(button => button.id);\n    const isActive = activeButtonsIds.includes(button.id);\n\n    return (\n      <CustomComponent\n        parentContext={parentContext}\n        toolbarClickCallback={_handleToolbarButtonClick.bind(this)}\n        button={button}\n        key={button.id}\n        activeButtons={activeButtonsIds}\n        isActive={isActive}\n      />\n    );\n  }\n}\n\nfunction _getExpandableButtonComponent(button, activeButtons) {\n  // Iterate over button definitions and update `onClick` behavior\n  let activeCommand;\n  const childButtons = button.buttons.map(childButton => {\n    childButton.onClick = _handleToolbarButtonClick.bind(this, childButton);\n\n    if (activeButtons.map(button => button.id).indexOf(childButton.id) > -1) {\n      activeCommand = childButton.id;\n    }\n\n    return childButton;\n  });\n\n  return (\n    <ExpandableToolMenu\n      key={button.id}\n      label={button.label}\n      icon={button.icon}\n      buttons={childButtons}\n      activeCommand={activeCommand}\n    />\n  );\n}\n\nfunction _getDefaultButtonComponent(button, activeButtons) {\n  return (\n    <ToolbarButton\n      key={button.id}\n      label={button.label}\n      icon={button.icon}\n      onClick={_handleToolbarButtonClick.bind(this, button)}\n      isActive={activeButtons.map(button => button.id).includes(button.id)}\n    />\n  );\n}\n/**\n * Determine which extension buttons should be showing, if they're\n * active, and what their onClick behavior should be.\n */\nfunction _getButtonComponents(toolbarButtons, activeButtons) {\n  const _this = this;\n  return toolbarButtons.map(button => {\n    const hasCustomComponent = button.CustomComponent;\n    const hasNestedButtonDefinitions = button.buttons && button.buttons.length;\n\n    if (hasCustomComponent) {\n      return _getCustomButtonComponent.call(_this, button, activeButtons);\n    }\n\n    if (hasNestedButtonDefinitions) {\n      return _getExpandableButtonComponent.call(_this, button, activeButtons);\n    }\n\n    return _getDefaultButtonComponent.call(_this, button, activeButtons);\n  });\n}\n\n/**\n * TODO: DEPRECATE\n * This is used exclusively in `extensions/cornerstone/src`\n * We have better ways with new UI Services to trigger \"builtin\" behaviors\n *\n * A handy way for us to handle different button types. IE. firing commands for\n * buttons, or initiation built in behavior.\n *\n * @param {*} button\n * @param {*} evt\n * @param {*} props\n */\nfunction _handleToolbarButtonClick(button, evt, props) {\n  const { activeButtons } = this.state;\n\n  if (button.commandName) {\n    const options = Object.assign({ evt }, button.commandOptions);\n    commandsManager.runCommand(button.commandName, options);\n  }\n\n  // TODO: Use Types ENUM\n  // TODO: We can update this to be a `getter` on the extension to query\n  //       For the active tools after we apply our updates?\n  if (button.type === 'setToolActive') {\n    const toggables = activeButtons.filter(\n      ({ options }) => options && !options.togglable\n    );\n    this.setState({ activeButtons: [...toggables, button] });\n  } else if (button.type === 'builtIn') {\n    this._handleBuiltIn(button);\n  }\n}\n\n/**\n *\n */\nfunction _getVisibleToolbarButtons() {\n  const toolbarModules = extensionManager.modules[MODULE_TYPES.TOOLBAR];\n  const toolbarButtonDefinitions = [];\n\n  toolbarModules.forEach(extension => {\n    const { definitions, defaultContext } = extension.module;\n    definitions.forEach(definition => {\n      const context = definition.context || defaultContext;\n\n      if (this.props.activeContexts.includes(context)) {\n        toolbarButtonDefinitions.push(definition);\n      }\n    });\n  });\n\n  return toolbarButtonDefinitions;\n}\n\nfunction _handleBuiltIn(button) {\n  /* TODO: Keep cine button active until its unselected. */\n  const { dialog, t } = this.props;\n  const { dialogId } = this.state;\n  const { id, options } = button;\n\n  if (options.behavior === 'CINE') {\n    if (dialogId) {\n      dialog.dismiss({ id: dialogId });\n      this.setState(state => ({\n        dialogId: null,\n        activeButtons: [\n          ...state.activeButtons.filter(button => button.id !== id),\n        ],\n      }));\n    } else {\n      const spacing = 20;\n      const { x, y } = document\n        .querySelector(`.ViewerMain`)\n        .getBoundingClientRect();\n      const newDialogId = dialog.create({\n        content: ConnectedCineDialog,\n        defaultPosition: {\n          x: x + spacing || 0,\n          y: y + spacing || 0,\n        },\n      });\n      this.setState(state => ({\n        dialogId: newDialogId,\n        activeButtons: [...state.activeButtons, button],\n      }));\n    }\n  }\n\n  if (options.behavior === 'DOWNLOAD_SCREEN_SHOT') {\n    commandsManager.runCommand('showDownloadViewportModal', {\n      title: t('Download High Quality Image'),\n    });\n  }\n}\n\nexport default withTranslation(['Common', 'ViewportDownloadForm'])(\n  withModal(withDialog(withAppContext(ToolbarRow)))\n);\n","import { OHIF, utils } from '@ohif/core';\nimport { connect } from 'react-redux';\nimport { StudyBrowser } from '@ohif/ui';\nimport cloneDeep from 'lodash.clonedeep';\nimport findDisplaySetByUID from './findDisplaySetByUID';\n\nconst { studyMetadataManager } = OHIF.utils;\n\nconst { clearViewportSpecificData, setActiveViewportSpecificData, setViewportLayoutAndData } = OHIF.redux.actions;\n\n// TODO\n// - Determine in which display set is active from Redux (activeViewportIndex and layout viewportData)\n// - Pass in errors and stack loading progress from Redux\nconst mapStateToProps = (state, ownProps) => {\n  // If we know that the stack loading progress details have changed,\n  // we can try to update the component state so that the thumbnail\n  // progress bar is updated\n  const stackLoadingProgressMap = state.loading.progress;\n  const studiesWithLoadingData = cloneDeep(ownProps.studies);\n\n  studiesWithLoadingData.forEach(study => {\n    study.thumbnails.forEach(data => {\n      const { displaySetInstanceUID } = data;\n      const stackId = `StackProgress:${displaySetInstanceUID}`;\n      const stackProgressData = stackLoadingProgressMap[stackId];\n\n      let stackPercentComplete = 0;\n      if (stackProgressData) {\n        stackPercentComplete = stackProgressData.percentComplete;\n      }\n\n      data.stackPercentComplete = stackPercentComplete;\n    });\n  });\n\n  return {\n    studies: studiesWithLoadingData,\n  };\n};\n\nconst mapDispatchToProps = (dispatch, ownProps) => {\n  return {\n    onThumbnailClick: (displaySetInstanceUID, seriesInstanceUID) => {\n      console.log(\"onThumbnailClick\");\n      console.log(seriesInstanceUID);\n      console.log(ownProps.studyMetadata);\n      var displaySets = [];\n      var numFrames = 0;\n      for (var i=0; i<ownProps.studyMetadata.length; i++) {\n        var study = ownProps.studyMetadata[i];\n        for (var j=0; j<study.displaySets.length; j++) {\n          var set = study.displaySets[j];\n          if (set.SeriesInstanceUID === seriesInstanceUID) {\n            displaySets.push(set);\n            if (!set.Maximized) numFrames++;\n          }\n        }\n      }\n      console.log(displaySets);\n\n      /*\n      let displaySet = findDisplaySetByUID(\n        ownProps.studyMetadata,\n        displaySetInstanceUID\n      );\n      */\n\n      /*\n      if (displaySet.isDerived) {\n        const { Modality } = displaySet;\n\n        displaySet = displaySet.getSourceDisplaySet(ownProps.studyMetadata);\n\n        if (!displaySet) {\n          throw new Error(\n            `Referenced series for ${Modality} dataset not present.`\n          );\n        }\n\n        if (!displaySet) {\n          throw new Error('Source data not present');\n        }\n      }\n      */\n\n      var numRows = 2;\n      var numColumns = 2;\n\n      if (numFrames == 1) {\n        numRows = 1;\n        numColumns = 1;\n      } else if (numFrames == 2) {\n        numRows = 1;\n        numColumns = 2;\n      } else if (numFrames == 3) {\n        numRows = 1;\n        numColumns = 3;\n      } else if (numFrames == 4) {\n        numRows = 2;\n        numColumns = 2;\n      } else if (numFrames == 5) {\n        numRows = 2;\n        numColumns = 3;\n      } else if (numFrames == 6) {\n        numRows = 2;\n        numColumns = 3;\n      } else if (numFrames == 7) {\n        numRows = 2;\n        numColumns = 4;\n      } else if (numFrames == 8) {\n        numRows = 2;\n        numColumns = 4;\n      } else if (numFrames == 9) {\n        numRows = 3;\n        numColumns = 3;\n      } else if (numFrames == 10) {\n        numRows = 3;\n        numColumns = 4;\n      }\n\n      var viewports = [];\n      for (var i=0; i<numFrames; i++) {\n        viewports.push({plugin: \"cornerstone\"});\n      }\n\n      dispatch(setViewportLayoutAndData(\n        {numRows: numRows, numColumns: numColumns, viewports: viewports},\n        displaySets\n      ));\n    },\n  };\n};\n\nconst ConnectedStudyBrowser = connect(\n  mapStateToProps,\n  mapDispatchToProps\n)(StudyBrowser);\n\nexport default ConnectedStudyBrowser;\n","import React from 'react';\nimport { useDrop } from 'react-dnd';\nimport PropTypes from 'prop-types';\nimport classNames from 'classnames';\nimport './ViewportPane.css';\n\nconst ViewportPane = function (props) {\n  console.log(\"ViewportPane\");\n\n  const { children, onDrop, onClick, viewportIndex, className: propClassName } = props;\n  const [{ hovered, highlighted }, drop] = useDrop({\n    accept: 'thumbnail',\n    drop: (droppedItem, monitor) => {\n      const canDrop = monitor.canDrop();\n      const isOver = monitor.isOver();\n\n      if (canDrop && isOver && onDrop) {\n        const { StudyInstanceUID, displaySetInstanceUID } = droppedItem;\n\n        onDrop({ viewportIndex, StudyInstanceUID, displaySetInstanceUID });\n      }\n    },\n    // Monitor, and collect props.\n    // Returned as values by `useDrop`\n    collect: monitor => ({\n      highlighted: monitor.canDrop(),\n      hovered: monitor.isOver(),\n    }),\n  });\n\n  return (\n    <div\n      className={classNames(\n        'viewport-drop-target',\n        { hovered: hovered },\n        { highlighted: highlighted },\n        propClassName\n      )}\n      ref={drop}\n      data-cy={`viewport-container-${viewportIndex}`}\n      onClick={ev => onClick(viewportIndex)}\n    >\n      {children}\n    </div>\n  );\n};\n\nViewportPane.propTypes = {\n  children: PropTypes.node.isRequired,\n  viewportIndex: PropTypes.number.isRequired,\n  onDrop: PropTypes.func.isRequired,\n  onClick: PropTypes.func.isRequired,\n  className: PropTypes.string,\n};\n\nexport default ViewportPane;\n","import './ViewportGrid.css';\n\nimport React, { useEffect } from 'react';\nimport PropTypes from 'prop-types';\nimport classNames from 'classnames';\nimport { utils } from '@ohif/core';\nimport { useSnackbarContext } from '@ohif/ui';\nimport cloneDeep from 'lodash.clonedeep';\n//\nimport ViewportPane from './ViewportPane.js';\nimport DefaultViewport from './DefaultViewport.js';\nimport EmptyViewport from './EmptyViewport.js';\n\nconst { loadAndCacheDerivedDisplaySets } = utils;\n\nconst ViewportGrid = function (props) {\n  var {\n    activeViewportIndex,\n    availablePlugins,\n    defaultPlugin: defaultPluginName,\n    layout,\n    numRows,\n    numColumns,\n    setViewportData,\n    studies,\n    viewportData,\n    children,\n    isStudyLoaded,\n    maximized,\n    onSetActiveViewport\n  } = props;\n\n  console.log(\"ViewportGrid\");\n  console.log(maximized);\n\n  /*\n  const displaySet = viewportData[0];\n\n  if (displaySet) {\n    var numFrames = displaySet.numImageFrames;\n    displaySet.frameIndex = 0;\n\n    // try to find clones of display set in studies\n    // use them to fill up grid (viewport data)\n    var j = 1;\n    studies.forEach(study => {\n      study.displaySets.forEach(set => {\n        if (set.clonedUID && set.clonedUID === displaySet.displaySetInstanceUID) {\n          set.frameIndex = j; // reset index if it was changed by user\n          viewportData[j] = set;\n          j++;\n        }\n      });\n    });\n\n    // if we did not find any clone, make clones\n    if (j == 1) {\n      for (var i=1; i<numFrames; i++) {\n        //layout.viewports.push({});\n        var ds = cloneDeep(displaySet);\n        ds.frameIndex = i;\n        ds.displaySetInstanceUID = utils.guid();\n        ds.clonedUID = displaySet.displaySetInstanceUID;\n        viewportData[i] = ds;\n      }\n\n      // find study with this display set\n      var relevantStudy;\n      var relevantDisplaySet;\n      studies.forEach(study => {\n        study.displaySets.forEach(set => {\n          if (set.displaySetInstanceUID === displaySet.displaySetInstanceUID) {\n            relevantStudy = study;\n            relevantDisplaySet = set;\n          }\n        });\n      });\n\n      // if found, add the cloned display sets\n      if (relevantStudy) {\n        for (var k=1; k < numFrames; k++) {\n          var ds = viewportData[k];\n          ds.images = relevantDisplaySet.images;\n          relevantStudy.displaySets.push(ds);\n        }\n      }\n    }\n  }\n  */\n\n  const effectiveNumRows = maximized ? 1 : numRows;\n  const effectiveNumColumns = maximized ? 1 : numColumns;\n\n  const rowSize = 100 / effectiveNumRows;\n  const colSize = 100 / effectiveNumColumns;\n\n  // http://grid.malven.co/\n  if (!viewportData || !viewportData.length) {\n    return null;\n  }\n\n  const snackbar = useSnackbarContext();\n\n  useEffect(() => {\n    if (isStudyLoaded) {\n      viewportData.forEach(displaySet => {\n        console.log(\"loadAndCacheDerivedDisplaySets\");\n        const promises = loadAndCacheDerivedDisplaySets(displaySet, studies);\n\n        promises.forEach(promise => {\n          promise.catch(error => {\n            snackbar.show({\n              title: 'Error loading derived display set:',\n              message: error.message,\n              type: 'error',\n              error,\n              autoClose: false,\n            });\n          });\n        });\n      });\n    }\n  }, [studies, viewportData, isStudyLoaded, snackbar]);\n\n  const getMaximizedViewportPane = (layout, viewportIndex) => {\n    console.log(\"In getMaximizedViewportPane\");\n    console.log(viewportData);\n    var displaySet = viewportData[viewportIndex];\n\n    for (var i=0; i<viewportData.length; i++) {\n      var set = viewportData[i];\n      if (set.Maximized) {\n        displaySet = set;\n        break;\n      }\n    }\n\n    set.frameIndex = viewportIndex;\n\n    console.log(\"In getMaximizedViewportPane, after fetching maximized display set:\");\n    console.log(displaySet);\n\n    if (!displaySet) {\n      return null;\n    }\n\n    const data = {\n      displaySet,\n      studies,\n    };\n\n    // JAMES TODO:\n\n    // Use whichever plugin is currently in use in the panel\n    // unless nothing is specified. If nothing is specified\n    // and the display set has a plugin specified, use that.\n    //\n    // TODO: Change this logic to:\n    // - Plugins define how capable they are of displaying a SopClass\n    // - When updating a panel, ensure that the currently enabled plugin\n    // in the viewport is capable of rendering this display set. If not\n    // then use the most capable available plugin\n\n    const pluginName =\n      !layout.plugin && displaySet && displaySet.plugin\n        ? displaySet.plugin\n        : layout.plugin;\n\n    const ViewportComponent = _getViewportComponent(\n      data, // Why do we pass this as `ViewportData`, when that's not really what it is?\n      viewportIndex,\n      children,\n      availablePlugins,\n      pluginName,\n      defaultPluginName\n    );\n\n    return (\n      <ViewportPane\n        onDrop={setViewportData}\n        onClick={() => null}\n        viewportIndex={viewportIndex} // Needed by `setViewportData`\n        className={classNames('viewport-container', {\n          active: activeViewportIndex === viewportIndex,\n        })}\n        key={viewportIndex}\n      >\n        {ViewportComponent}\n      </ViewportPane>\n    );\n  };\n\n  const getViewportPane = (layout, viewportIndex) => {\n    var displaySet = viewportData[viewportIndex];\n\n    console.log(\"In getViewportPanes viewport loop. Display set:\");\n    console.log(displaySet);\n\n    if (!displaySet) {\n      return null;\n    }\n\n    const data = {\n      displaySet,\n      studies,\n    };\n\n    // JAMES TODO:\n\n    // Use whichever plugin is currently in use in the panel\n    // unless nothing is specified. If nothing is specified\n    // and the display set has a plugin specified, use that.\n    //\n    // TODO: Change this logic to:\n    // - Plugins define how capable they are of displaying a SopClass\n    // - When updating a panel, ensure that the currently enabled plugin\n    // in the viewport is capable of rendering this display set. If not\n    // then use the most capable available plugin\n\n    const pluginName =\n      !layout.plugin && displaySet && displaySet.plugin\n        ? displaySet.plugin\n        : layout.plugin;\n\n    const ViewportComponent = _getViewportComponent(\n      data, // Why do we pass this as `ViewportData`, when that's not really what it is?\n      viewportIndex,\n      children,\n      availablePlugins,\n      pluginName,\n      defaultPluginName\n    );\n\n    return (\n      <ViewportPane\n        onDrop={setViewportData}\n        onClick={onSetActiveViewport}\n        viewportIndex={viewportIndex} // Needed by `setViewportData`\n        className={classNames('viewport-container', {\n          active: activeViewportIndex === viewportIndex,\n        })}\n        key={viewportIndex}\n      >\n        {ViewportComponent}\n      </ViewportPane>\n    );\n  };\n\n  const getViewportPanes = () => {\n    console.log(\"getViewportPanes\");\n    if (maximized) {\n      return [getMaximizedViewportPane(layout, activeViewportIndex)];\n    } else {\n      return layout.viewports.map((layout, idx) => getViewportPane(layout, idx));\n    }\n  };\n\n  /*\n  const ViewportPanes = React.useMemo(getViewportPanes, [\n    layout,\n    viewportData,\n    studies,\n    children,\n    availablePlugins,\n    defaultPluginName,\n    setViewportData,\n    activeViewportIndex,\n    maximized\n  ]);\n  */\n\n  const ViewportPanes = getViewportPanes();\n\n  return (\n    <div\n      data-cy=\"viewprt-grid\"\n      style={{\n        display: 'grid',\n        gridTemplateRows: `repeat(${effectiveNumRows}, ${rowSize}%)`,\n        gridTemplateColumns: `repeat(${effectiveNumColumns}, ${colSize}%)`,\n        height: '100%',\n        width: '100%',\n      }}\n    >\n      {ViewportPanes}\n    </div>\n  );\n};\n\nViewportGrid.propTypes = {\n  viewportData: PropTypes.array.isRequired,\n  supportsDrop: PropTypes.bool.isRequired,\n  activeViewportIndex: PropTypes.number.isRequired,\n  layout: PropTypes.object.isRequired,\n  availablePlugins: PropTypes.object.isRequired,\n  setViewportData: PropTypes.func.isRequired,\n  studies: PropTypes.array,\n  children: PropTypes.node,\n  defaultPlugin: PropTypes.string,\n  numRows: PropTypes.number.isRequired,\n  numColumns: PropTypes.number.isRequired,\n  maximized: PropTypes.bool.isRequired\n};\nViewportGrid.defaultProps = {\n  viewportData: [],\n  numRows: 1,\n  numColumns: 1,\n  layout: {\n    viewports: [{}],\n  },\n  activeViewportIndex: 0,\n  supportsDrop: true,\n  availablePlugins: {\n    DefaultViewport,\n  },\n  defaultPlugin: 'defaultViewportPlugin',\n  maximized: false\n};\n\n/**\n *\n *\n * @param {*} plugin\n * @param {*} viewportData\n * @param {*} viewportIndex\n * @param {*} children\n * @returns\n */\nfunction _getViewportComponent(\n  viewportData,\n  viewportIndex,\n  children,\n  availablePlugins,\n  pluginName,\n  defaultPluginName\n) {\n  console.log(\"_getViewportComponent\");\n  if (viewportData.displaySet) {\n    pluginName = pluginName || defaultPluginName;\n    const ViewportComponent = availablePlugins[pluginName];\n\n    if (!ViewportComponent) {\n      throw new Error(\n        `No Viewport Component available for name ${pluginName}.\n         Available plugins: ${JSON.stringify(availablePlugins)}`\n      );\n    }\n\n    return (\n      <ViewportComponent\n        viewportData={viewportData}\n        viewportIndex={viewportIndex}\n        children={[children]}\n      />\n    );\n  }\n\n  return <EmptyViewport />;\n}\n\nexport default ViewportGrid;\n","/**\n *\n *\n * @export\n * @param {*} props\n * @returns\n */\nexport default function DefaultViewport(props) {\n  return <div>{JSON.stringify(props)}</div>;\n}\n","import ViewportGrid from './ViewportGrid.js';\nimport { MODULE_TYPES } from '@ohif/core';\nimport { connect } from 'react-redux';\nimport { extensionManager } from './../../App.js';\nimport memoize from 'lodash/memoize';\nimport OHIF from '@ohif/core';\nconst { setViewportActive } = OHIF.redux.actions;\n\nconst getAvailableViewportModules = memoize(viewportModules => {\n  const availableViewportModules = {};\n  viewportModules.forEach(moduleDefinition => {\n    availableViewportModules[moduleDefinition.extensionId] =\n      moduleDefinition.module;\n  });\n  return availableViewportModules;\n});\n\nconst mapStateToProps = state => {\n  const viewportModules = extensionManager.modules[MODULE_TYPES.VIEWPORT];\n  const availableViewportModules = getAvailableViewportModules(viewportModules);\n\n  // TODO: Use something like state.plugins.defaultPlugin[MODULE_TYPES.VIEWPORT]\n  let defaultPlugin;\n  if (viewportModules.length) {\n    defaultPlugin = viewportModules[0].extensionId;\n  }\n\n  const { numRows, numColumns, layout, activeViewportIndex } = state.viewports;\n\n  return {\n    numRows,\n    numColumns,\n    layout,\n    activeViewportIndex,\n    // TODO: rename `availableViewportModules`\n    availablePlugins: availableViewportModules,\n    // TODO: rename `defaultViewportModule`\n    defaultPlugin,\n  };\n};\n\nconst mapDispatchToProps = dispatch => {\n  return {\n    onSetActiveViewport: index => {\n      dispatch(setViewportActive(index));\n    }\n  };\n};\n\nconst ConnectedViewportGrid = connect(\n  mapStateToProps,\n  mapDispatchToProps\n)(ViewportGrid);\n\nexport default ConnectedViewportGrid;\n","import './ViewerMain.css';\n\nimport { Component } from 'react';\nimport { ConnectedViewportGrid } from './../components/DentalGrid/index.js';\nimport PropTypes from 'prop-types';\nimport React from 'react';\nimport memoize from 'lodash/memoize';\nimport _values from 'lodash/values';\n\nvar values = memoize(_values);\n\nclass ViewerMain extends Component {\n  static propTypes = {\n    activeViewportIndex: PropTypes.number.isRequired,\n    studies: PropTypes.array,\n    viewportSpecificData: PropTypes.object.isRequired,\n    layout: PropTypes.object.isRequired,\n    setViewportSpecificData: PropTypes.func.isRequired,\n    clearViewportSpecificData: PropTypes.func.isRequired,\n    maximized: PropTypes.bool.isRequired\n  };\n\n  constructor(props) {\n    super(props);\n\n    this.state = {\n      displaySets: [],\n    };\n  }\n\n  getDisplaySets(studies) {\n    if (!studies || studies.length == 0) return [];\n    var study = studies[0];\n\n    if (!study.displaySets || study.displaySets.length == 0) return [];\n    var seriesNumber = study.displaySets[0].SeriesNumber;\n\n    const displaySets = [];\n    study.displaySets.forEach(dSet => {\n      if (dSet.SeriesNumber === seriesNumber) {\n        if (!dSet.plugin) {\n          dSet.plugin = 'cornerstone';\n        }\n        displaySets.push(dSet);\n      }\n    });\n\n    return displaySets;\n  }\n\n  findDisplaySet(studies, StudyInstanceUID, displaySetInstanceUID) {\n    const study = studies.find(study => {\n      return study.StudyInstanceUID === StudyInstanceUID;\n    });\n\n    if (!study) {\n      return;\n    }\n\n    return study.displaySets.find(displaySet => {\n      return displaySet.displaySetInstanceUID === displaySetInstanceUID;\n    });\n  }\n\n  componentDidMount() {\n    // Add beforeUnload event handler to check for unsaved changes\n    //window.addEventListener('beforeunload', unloadHandlers.beforeUnload);\n\n    // Get all the display sets for the viewer studies\n    if (this.props.studies) {\n      const displaySets = this.getDisplaySets(this.props.studies);\n      this.setState({ displaySets }, this.fillEmptyViewportPanes);\n    }\n  }\n\n  componentDidUpdate(prevProps) {\n    const prevViewportAmount = prevProps.layout.viewports.length;\n    const viewportAmount = this.props.layout.viewports.length;\n    const isVtk = this.props.layout.viewports.some(vp => !!vp.vtk);\n\n    if (\n      this.props.studies !== prevProps.studies ||\n      (viewportAmount !== prevViewportAmount && !isVtk)\n    ) {\n      const displaySets = this.getDisplaySets(this.props.studies);\n      this.setState({ displaySets }, this.fillEmptyViewportPanes);\n    }\n  }\n\n  fillEmptyViewportPanes = () => {\n    // TODO: Here is the entry point for filling viewports on load.\n    const dirtyViewportPanes = [];\n    const { layout, viewportSpecificData } = this.props;\n    const { displaySets } = this.state;\n\n    if (!displaySets || !displaySets.length) {\n      return;\n    }\n\n    for (let i = 0; i < layout.viewports.length; i++) {\n      const viewportPane = viewportSpecificData[i];\n      const isNonEmptyViewport =\n        viewportPane &&\n        viewportPane.StudyInstanceUID &&\n        viewportPane.displaySetInstanceUID;\n\n      if (isNonEmptyViewport) {\n        dirtyViewportPanes.push({\n          StudyInstanceUID: viewportPane.StudyInstanceUID,\n          displaySetInstanceUID: viewportPane.displaySetInstanceUID,\n        });\n\n        continue;\n      }\n\n      const foundDisplaySet =\n        displaySets.find(\n          ds =>\n            !dirtyViewportPanes.some(\n              v => v.displaySetInstanceUID === ds.displaySetInstanceUID\n            )\n        ) || displaySets[displaySets.length - 1];\n\n      dirtyViewportPanes.push(foundDisplaySet);\n    }\n\n    dirtyViewportPanes.forEach((vp, i) => {\n      if (vp && vp.StudyInstanceUID) {\n        this.setViewportData({\n          viewportIndex: i,\n          StudyInstanceUID: vp.StudyInstanceUID,\n          displaySetInstanceUID: vp.displaySetInstanceUID,\n        });\n      }\n    });\n  };\n\n  setViewportData = ({\n    viewportIndex,\n    StudyInstanceUID,\n    displaySetInstanceUID,\n  }) => {\n    let displaySet = this.findDisplaySet(\n      this.props.studies,\n      StudyInstanceUID,\n      displaySetInstanceUID\n    );\n\n    if (displaySet) {\n      if (displaySet.isDerived) {\n        const { Modality } = displaySet;\n        displaySet = displaySet.getSourceDisplaySet(this.props.studies);\n\n        if (!displaySet) {\n          throw new Error(\n            `Referenced series for ${Modality} dataset not present.`\n          );\n        }\n      }\n\n      this.props.setViewportSpecificData(viewportIndex, displaySet);\n    }\n  };\n\n  render() {\n    const { viewportSpecificData } = this.props;\n    const viewportData = values(viewportSpecificData);\n\n    return (\n      <div className=\"ViewerMain\">\n        {this.state.displaySets.length && (\n          <ConnectedViewportGrid\n            isStudyLoaded={this.props.isStudyLoaded}\n            studies={this.props.studies}\n            viewportData={viewportData}\n            setViewportData={this.setViewportData}\n            maximized={this.props.maximized}\n          >\n            {/* Children to add to each viewport that support children */}\n          </ConnectedViewportGrid>\n        )}\n      </div>\n    );\n  }\n\n  componentWillUnmount() {\n    // Clear the entire viewport specific data\n    const { viewportSpecificData } = this.props;\n    Object.keys(viewportSpecificData).forEach(viewportIndex => {\n      this.props.clearViewportSpecificData(viewportIndex);\n    });\n\n    // TODO: These don't have to be viewer specific?\n    // Could qualify for other routes?\n    // hotkeys.destroy();\n\n    // Remove beforeUnload event handler...\n    //window.removeEventListener('beforeunload', unloadHandlers.beforeUnload);\n    // Destroy the synchronizer used to update reference lines\n    //OHIF.viewer.updateImageSynchronizer.destroy();\n    // TODO: Instruct all plugins to clean up themselves\n    //\n    // Clear references to all stacks in the StackManager\n    //StackManager.clearStacks();\n    // @TypeSafeStudies\n    // Clears OHIF.viewer.Studies collection\n    //OHIF.viewer.Studies.removeAll();\n    // @TypeSafeStudies\n    // Clears OHIF.viewer.StudyMetadataList collection\n    //OHIF.viewer.StudyMetadataList.removeAll();\n  }\n}\n\nexport default ViewerMain;\n","import OHIF from '@ohif/core';\nimport ViewerMain from './ViewerMain';\nimport { connect } from 'react-redux';\n\nconst {\n  setViewportSpecificData,\n  clearViewportSpecificData,\n} = OHIF.redux.actions;\n\nconst mapStateToProps = state => {\n  const { activeViewportIndex, layout, viewportSpecificData, maximized } = state.viewports;\n\n  return {\n    activeViewportIndex,\n    layout,\n    viewportSpecificData,\n    viewports: state.viewports,\n    maximized\n  };\n};\n\nconst mapDispatchToProps = dispatch => {\n  return {\n    setViewportSpecificData: (viewportIndex, data) => {\n      dispatch(setViewportSpecificData(viewportIndex, data));\n    },\n    clearViewportSpecificData: () => {\n      dispatch(clearViewportSpecificData());\n    },\n  };\n};\n\nconst ConnectedViewerMain = connect(\n  mapStateToProps,\n  mapDispatchToProps\n)(ViewerMain);\n\nexport default ConnectedViewerMain;\n","import './SidePanel.css';\n\nimport React from 'react';\nimport PropTypes from 'prop-types';\nimport classNames from 'classnames';\n\nconst SidePanel = ({ from, isOpen, children, width }) => {\n  const fromSideClass = from === 'right' ? 'from-right' : 'from-left';\n\n  const styles = width\n    ? {\n        maxWidth: width,\n        marginRight: isOpen ? '0' : Number.parseInt(width) * -1,\n      }\n    : {};\n\n  return (\n    <section\n      style={styles}\n      className={classNames('sidepanel', fromSideClass, {\n        'is-open': isOpen,\n      })}\n    >\n      {children}\n    </section>\n  );\n};\n\nSidePanel.propTypes = {\n  from: PropTypes.string.isRequired,\n  isOpen: PropTypes.bool.isRequired,\n  children: PropTypes.node,\n  width: PropTypes.string,\n};\n\nexport default SidePanel;\n","import React, { useState } from 'react';\nimport classnames from 'classnames';\nimport PropTypes from 'prop-types';\nimport { ErrorBoundary, Icon } from '@ohif/ui';\nimport { servicesManager } from './../../App';\n\nimport './ErrorBoundaryDialog.css';\n\nconst { UIModalService } = servicesManager.services;\n\nconst ErrorBoundaryDialog = ({ context, children }) => {\n  const handleOnError = (error, componentStack) => {\n    const ErrorDialog = () => {\n      const [open, setOpen] = useState(false);\n\n      return (\n        <div className=\"ErrorFallback\" role=\"alert\">\n          <div className=\"ErrorBoundaryDialog\">\n            <h3 className=\"ErrorBoundaryDialogTitle\">\n              {context}: <span>{error.message}</span>\n            </h3>\n          </div>\n          <button\n            className=\"btn btn-primary btn-sm ErrorBoundaryDialogButton\"\n            onClick={() => setOpen(s => !s)}\n          >\n            <Icon\n              name=\"chevron-down\"\n              className={classnames('ErrorBoundaryDialogIcon', {\n                opened: open,\n              })}\n            />\n            Stack Trace\n          </button>\n\n          {open && <pre>{componentStack}</pre>}\n        </div>\n      );\n    };\n\n    UIModalService.show({\n      content: ErrorDialog,\n      title: `Something went wrong in ${context}`,\n    });\n  };\n\n  const fallbackComponent = () => (\n    <div className=\"ErrorFallback\" role=\"alert\">\n      <p>\n        Error rendering {context}. <br /> Check the browser console for more\n        details.\n      </p>\n    </div>\n  );\n\n  return (\n    <ErrorBoundary\n      fallbackComponent={fallbackComponent}\n      context={context}\n      onError={handleOnError}\n    >\n      {children}\n    </ErrorBoundary>\n  );\n};\n\nErrorBoundaryDialog.propTypes = {\n  context: PropTypes.string.isRequired,\n  children: PropTypes.node.isRequired,\n};\n\nexport default ErrorBoundaryDialog;\n","import ErrorBoundaryDialog from './ErrorBoundaryDialog';\n\nexport default ErrorBoundaryDialog;\n","import { Component } from 'react';\nimport React from 'react';\nimport PropTypes from 'prop-types';\nimport { TableList, TableListItem } from '@ohif/ui';\nimport SimpleDialog from '../SimpleDialog/SimpleDialog.js';\nimport './LayoutPickerDialog.css';\n\nexport default class LayoutPickerDialog extends Component {\n  static propTypes = {\n    //description: PropTypes.string,\n    //measurementData: PropTypes.object.isRequired,\n    onCancel: PropTypes.func.isRequired,\n    onConfirm: PropTypes.func.isRequired,\n  };\n\n  constructor(props) {\n    super(props);\n\n    this.state = {\n      layouts: ['Panoramic', 'Four Bitewings'],\n      pick: -1\n    };\n  }\n\n  /*\n  componentDidUpdate(prevProps) {\n    if (this.props.description !== prevProps.description) {\n      this.setState({\n        description: this.props.description,\n      });\n    }\n  }\n  */\n\n  render() {\n    return (\n      <SimpleDialog\n        headerTitle=\"Pick Layout\"\n        onClose={this.onClose}\n        onConfirm={this.onConfirm}\n        rootClass=\"LayoutPickerDialog\"\n      >\n        <TableList headless={true}>\n          {this.state.layouts.map((name, index) =>\n            <TableListItem\n              itemClass={index == this.state.pick ? \"SelectedLayoutPickerItem\" : \"LayoutPickerItem\"}\n              itemMetaClass=\"LayoutPickerItemMeta\"\n              onItemClick={() => this.setState({pick: index})}\n            >{name}</TableListItem>\n          )}\n        </TableList>\n      </SimpleDialog>\n    );\n  }\n\n  onClose = () => {\n    this.props.onCancel();\n  };\n\n  onConfirm = e => {\n    e.preventDefault();\n    var layout = this.state.pick < 0 ? null : this.state.layouts[this.state.pick];\n    this.props.onConfirm(layout);\n  };\n}\n","import LayoutPickerDialog from './LayoutPickerDialog';\n\nexport default LayoutPickerDialog;\n","import React, { Component } from 'react';\nimport PropTypes from 'prop-types';\nimport classNames from 'classnames';\n\nimport OHIF, { MODULE_TYPES, DICOMSR } from '@ohif/core';\nimport { withDialog } from '@ohif/ui';\nimport moment from 'moment';\nimport ToolbarRow from './ToolbarRow.js';\nimport ConnectedStudyBrowser from './ConnectedStudyBrowser.js';\nimport ConnectedViewerMain from './ConnectedViewerMain.js';\nimport SidePanel from './../components/SidePanel.js';\nimport ErrorBoundaryDialog from './../components/ErrorBoundaryDialog';\nimport LayoutPickerDialog from './../components/LayoutPickerDialog';\nimport { extensionManager } from './../App.js';\nimport { user, utils } from '@ohif/core';\nimport { api } from 'dicomweb-client';\nimport dcmjs from 'dcmjs';\nconst { DicomMetaDictionary, DicomDict } = dcmjs.data;\n\n// Contexts\nimport WhiteLabelingContext from '../context/WhiteLabelingContext.js';\nimport UserManagerContext from '../context/UserManagerContext';\nimport AppContext from '../context/AppContext';\n\nimport './Viewer.css';\nimport { finished } from 'stream';\n\nconst { guid } = utils;\n\nclass Viewer extends Component {\n  static propTypes = {\n    studies: PropTypes.arrayOf(\n      PropTypes.shape({\n        StudyInstanceUID: PropTypes.string.isRequired,\n        StudyDate: PropTypes.string,\n        PatientID: PropTypes.string,\n        series: PropTypes.arrayOf(\n          PropTypes.shape({\n            SeriesInstanceUID: PropTypes.string.isRequired\n          })\n        ),\n        displaySets: PropTypes.arrayOf(\n          PropTypes.shape({\n            displaySetInstanceUID: PropTypes.string.isRequired,\n            SeriesInstanceUID: PropTypes.string.isRequired,\n            SeriesDescription: PropTypes.string,\n            SeriesNumber: PropTypes.number,\n            InstanceNumber: PropTypes.number,\n            numImageFrames: PropTypes.number,\n            Modality: PropTypes.string.isRequired,\n            images: PropTypes.arrayOf(\n              PropTypes.shape({\n                getImageId: PropTypes.func.isRequired\n              })\n            ),\n          })\n        ),\n      })\n    ),\n    studyInstanceUIDs: PropTypes.array,\n    activeServer: PropTypes.shape({\n      type: PropTypes.string,\n      wadoRoot: PropTypes.string,\n    }),\n    onTimepointsUpdated: PropTypes.func,\n    onMeasurementsUpdated: PropTypes.func,\n    onMaximize: PropTypes.func,\n    onNewStudy: PropTypes.func,\n    // window.store.getState().viewports.viewportSpecificData\n    viewports: PropTypes.object.isRequired,\n    // window.store.getState().viewports.activeViewportIndex\n    activeViewportIndex: PropTypes.number.isRequired,\n    isStudyLoaded: PropTypes.bool,\n    dialog: PropTypes.object,\n    maximized: PropTypes.bool.isRequired,\n    patientID: PropTypes.string\n  };\n\n  constructor(props) {\n    super(props);\n\n    const { activeServer } = this.props;\n    const server = Object.assign({}, activeServer);\n\n    OHIF.measurements.MeasurementApi.setConfiguration({\n      dataExchange: {\n        retrieve: DICOMSR.retrieveMeasurements,\n        store: DICOMSR.storeMeasurements,\n      },\n      server,\n    });\n\n    OHIF.measurements.TimepointApi.setConfiguration({\n      dataExchange: {\n        retrieve: this.retrieveTimepoints,\n        store: this.storeTimepoints,\n        remove: this.removeTimepoint,\n        update: this.updateTimepoint,\n        disassociate: this.disassociateStudy,\n      },\n    });\n\n    this._getActiveViewport = this._getActiveViewport.bind(this);\n  }\n\n  state = {\n    isLeftSidePanelOpen: true,\n    isRightSidePanelOpen: false,\n    isSelectingLayout: false,\n    selectedRightSidePanel: '',\n    selectedLeftSidePanel: 'studies', // TODO: Don't hardcode this\n    thumbnails: [],\n  };\n\n  componentWillUnmount() {\n    if (this.props.dialog) {\n      this.props.dialog.dismissAll();\n    }\n  }\n\n  retrieveTimepoints = filter => {\n    OHIF.log.info('retrieveTimepoints');\n\n    // Get the earliest and latest study date\n    let earliestDate = new Date().toISOString();\n    let latestDate = new Date().toISOString();\n    if (this.props.studies) {\n      latestDate = new Date('1000-01-01').toISOString();\n      this.props.studies.forEach(study => {\n        const StudyDate = moment(study.StudyDate, 'YYYYMMDD').toISOString();\n        if (StudyDate < earliestDate) {\n          earliestDate = StudyDate;\n        }\n        if (StudyDate > latestDate) {\n          latestDate = StudyDate;\n        }\n      });\n    }\n\n    // Return a generic timepoint\n    return Promise.resolve([\n      {\n        timepointType: 'baseline',\n        timepointId: 'TimepointId',\n        studyInstanceUIDs: this.props.studyInstanceUIDs,\n        PatientID: filter.PatientID,\n        earliestDate,\n        latestDate,\n        isLocked: false,\n      },\n    ]);\n  };\n\n  storeTimepoints = timepointData => {\n    OHIF.log.info('storeTimepoints');\n    return Promise.resolve();\n  };\n\n  updateTimepoint = (timepointData, query) => {\n    OHIF.log.info('updateTimepoint');\n    return Promise.resolve();\n  };\n\n  removeTimepoint = timepointId => {\n    OHIF.log.info('removeTimepoint');\n    return Promise.resolve();\n  };\n\n  disassociateStudy = (timepointIds, StudyInstanceUID) => {\n    OHIF.log.info('disassociateStudy');\n    return Promise.resolve();\n  };\n\n  onTimepointsUpdated = timepoints => {\n    if (this.props.onTimepointsUpdated) {\n      this.props.onTimepointsUpdated(timepoints);\n    }\n  };\n\n  onMeasurementsUpdated = measurements => {\n    if (this.props.onMeasurementsUpdated) {\n      this.props.onMeasurementsUpdated(measurements);\n    }\n  };\n\n  componentDidMount() {\n    const { studies, isStudyLoaded } = this.props;\n    const { TimepointApi, MeasurementApi } = OHIF.measurements;\n    const currentTimepointId = 'TimepointId';\n\n    const timepointApi = new TimepointApi(currentTimepointId, {\n      onTimepointsUpdated: this.onTimepointsUpdated,\n    });\n\n    const measurementApi = new MeasurementApi(timepointApi, {\n      onMeasurementsUpdated: this.onMeasurementsUpdated,\n    });\n\n    this.currentTimepointId = currentTimepointId;\n    this.timepointApi = timepointApi;\n    this.measurementApi = measurementApi;\n\n    if (studies) {\n      const PatientID = studies[0] && studies[0].PatientID;\n\n      timepointApi.retrieveTimepoints({ PatientID });\n      if (isStudyLoaded) {\n        this.measurementApi.retrieveMeasurements(PatientID, [\n          currentTimepointId,\n        ]);\n      }\n\n      this.setState({\n        thumbnails: _mapStudiesToThumbnails(studies),\n      });\n    }\n  }\n\n  componentDidUpdate(prevProps) {\n    const { studies, isStudyLoaded } = this.props;\n\n    if (studies !== prevProps.studies) {\n      this.setState({\n        thumbnails: _mapStudiesToThumbnails(studies),\n      });\n    }\n    if (isStudyLoaded && isStudyLoaded !== prevProps.isStudyLoaded) {\n      const PatientID = studies[0] && studies[0].PatientID;\n      const { currentTimepointId } = this;\n\n      this.timepointApi.retrieveTimepoints({ PatientID });\n      this.measurementApi.retrieveMeasurements(PatientID, [currentTimepointId]);\n    }\n  }\n\n  _getActiveViewport() {\n    return this.props.viewports[this.props.activeViewportIndex];\n  }\n\n  getClient(url) {\n    const token = window.access_token;\n    console.log(\"token:\");\n    console.log(token);\n    const headers = {Authorization: 'Bearer ' + token};\n    return new api.DICOMwebClient({url, headers});\n  }\n\n  createNewStudy(layout) {\n    console.log(\"createNewStudy\");\n\n    // dialog should return some representation of layout, like frames, positions, etc\n    // then we create new study, series, structured display from that\n    // http://dicom.nema.org/medical/dicom/current/output/html/part18.html#chapter_F\n    \n    const fileMetaInformationVersionArray = new Uint8Array(2);\n    fileMetaInformationVersionArray[1] = 1;\n\n    const metadata = {\n      \"00020001\": { Value: [fileMetaInformationVersionArray.buffer], vr: \"OB\" },\n      \"00020012\": { Value: [\"1.2.840.113819.7.1.1997.1.0\"], vr: \"UI\" }, // TODO: update (Implementation Class UID)\n      \"00020002\": { Value: [\"1.2.840.10008.5.1.4.1.1.131\"], vr: \"UI\" }, // Media Storage SOP Class UID = Basic Structured Display Storage\n      \"00020003\": { Value: [DicomMetaDictionary.uid()], vr: \"UI\" },  // Media Storage SOP Instance UID = new uid\n      \"00020010\": { Value: [\"1.2.840.10008.1.2\"], vr: \"UI\" } // Transfer Syntax UID\n    };\n\n    var layout = {\n      StudyInstanceUID: guid(),\n      SeriesInstanceUID: guid(),\n      SOPInstanceUID: guid(),\n      SOPClassUID: \"1.2.840.10008.5.1.4.1.1.131\", // Structured Display\n      ImageBoxes: [\n        {\"00720302\": {vr: \"US\", Value: [0]}}, // Image Box Number\n        {\"00720302\": {vr: \"US\", Value: [1]}}, // Image Box Number\n        {\"00720302\": {vr: \"US\", Value: [2]}}  // Image Box Number\n      ]\n    };\n\n    var dict = new DicomDict(metadata);\n    dict.upsertTag(\"0020000D\", \"UI\", [layout.StudyInstanceUID]); // Study Instance UID\n    dict.upsertTag(\"0020000E\", \"UI\", [layout.SeriesInstanceUID]); // Series Instance UID\n    dict.upsertTag(\"00200013\", \"IS\", [\"0\"]); // Instance Number\n    dict.upsertTag(\"00080018\", \"UI\", [layout.SOPInstanceUID]); // SOP Instance UID\n    dict.upsertTag(\"00080016\", \"UI\", [layout.SOPClassUID]); \n    dict.upsertTag(\"00720422\", \"SQ\", layout.ImageBoxes); // Structured Display Image Box Sequence\n    dict.upsertTag(\"00100020\", \"LO\", [this.props.patientID]);\n\n    var buffer = dict.write();\n    console.log(\"buffer:\");\n    console.log(buffer);\n\n    const url = this.props.activeServer.wadoRoot;\n    console.log(url);\n\n    const client = this.getClient(url);\n    const props = this.props;\n    //var encoder = new TextEncoder();\n    //const buffer = encoder.encode(JSON.stringify(dataset));\n    client.storeInstances({ datasets: [buffer] }).then(function (result) {\n      props.onNewStudy(layout);\n    });\n\n    // then make dicomWeb call to create these in google healthcare\n    // after call, update redux state with new study, series and structured display\n    // that state should automatically be reflected by study browser and viewer\n  }\n\n  uploadImage() {\n    var index = this.props.activeViewportIndex;\n    var self = this;\n    this.loadImage(function (imageData) {\n      self.createNewImageInstance(index, imageData);\n    });\n  }\n\n  loadImage(onSuccess) {\n    const input = document.createElement('input');\n    input.setAttribute('type', 'file');\n    input.setAttribute('accept', 'image/*');\n    input.onchange = e => { \n      var file = e.target.files[0]; \n      var reader = new FileReader();\n      reader.onerror = ev => {\n        console.log(\"reader error\");\n        console.log(ev);\n      };\n      reader.onload = ev => {\n        const image = document.createElement('img');\n        image.src = ev.target.result;\n        image.decode()\n          .then(() => {\n            console.log(\"image onload\");\n            console.log(image.naturalWidth);\n            console.log(image.naturalHeight);\n            var canvas = document.createElement(\"canvas\");\n            canvas.width = image.naturalWidth;\n            canvas.height = image.naturalHeight;\n            var ctx = canvas.getContext(\"2d\");\n            ctx.drawImage(image, 0, 0);\n            var imageData = ctx.getImageData(0,0,canvas.width,canvas.height);\n            console.log(\"image data\");\n            console.log(imageData);\n            onSuccess(imageData);\n          })\n          .catch(err => {\n            console.log(err);\n          });\n      };\n      reader.readAsDataURL(file);\n    }\n\n    document.body.appendChild(input);\n    input.click();\n    document.body.removeChild(input);\n  }\n\n  createNewImageInstance(index, imageData) {\n    var viewport = this.props.viewports[index];\n    const fileMetaInformationVersionArray = new Uint8Array(2);\n    fileMetaInformationVersionArray[1] = 1;\n    const metadata = {\n      \"00020001\": { Value: [fileMetaInformationVersionArray.buffer], vr: \"OB\" },\n      \"00020012\": { Value: [\"1.2.840.113819.7.1.1997.1.0\"], vr: \"UI\" }, // TODO: update (Implementation Class UID)\n      \"00020002\": { Value: [\"1.2.840.10008.5.1.4.1.1.1.1\"], vr: \"UI\" }, // Media Storage SOP Class UID = Digital X-Ray Image Storage - For Presentation\n      \"00020003\": { Value: [DicomMetaDictionary.uid()], vr: \"UI\" },  // Media Storage SOP Instance UID = new uid\n      \"00020010\": { Value: [\"1.2.840.10008.1.2\"], vr: \"UI\" } // Transfer Syntax UID\n    };\n\n    var dict = new DicomDict(metadata);\n\n    dict.upsertTag(\"00100020\", \"LO\", [this.props.patientID]);\n    dict.upsertTag(\"0020000D\", \"UI\", [viewport.StudyInstanceUID]); // Study Instance UID\n    dict.upsertTag(\"0020000E\", \"UI\", [viewport.SeriesInstanceUID]); // Series Instance UID\n    dict.upsertTag(\"00200013\", \"IS\", [index.toString()]); // Instance Number\n    dict.upsertTag(\"00080018\", \"UI\", [guid()]); // SOP Instance UID\n    // Media Storage SOP Class UID = Digital X-Ray Image Storage - For Presentation\n    dict.upsertTag(\"00080016\", \"UI\", [\"1.2.840.10008.5.1.4.1.1.1.1\"]); \n    dict.upsertTag(\"00280006\", \"US\", [0]); // Planar Configuration\n    dict.upsertTag(\"00280004\", \"CS\", [\"RGB\"]); // Photometric Interpretation\n    dict.upsertTag(\"00280002\", \"US\", [3]); // Samples per Pixel\n    dict.upsertTag(\"00280010\", \"US\", [imageData.height]); // Rows\n    dict.upsertTag(\"00280011\", \"US\", [imageData.width]); // Columns\n    dict.upsertTag(\"00280100\", \"US\", [8]); // Bits Allocated\n    dict.upsertTag(\"00280101\", \"US\", [8]); // Bits Stored\n    dict.upsertTag(\"00280102\", \"US\", [7]); // High Bit\n    dict.upsertTag(\"00280103\", \"US\", [0]); // Pixel Representation\n\n    // convert from Uint8ClampedArray to Uint8Array\n    var pixels = new Uint8Array(imageData.data.buffer);\n    dict.upsertTag(\"7FE00010\", \"OB\", [pixels]); // Pixel Data\n\n    // TODO instance creation time\n\n    var buffer = dict.write();\n    const url = this.props.activeServer.wadoRoot;\n    const client = this.getClient(url);\n    const props = this.props;\n    client.storeInstances({ datasets: [buffer] }).then(function (result) {\n      console.log(\"result:\");\n      console.log(result);\n      //props.onNewStudy(layout);\n    });\n  }\n\n  render() {\n    let VisiblePanelLeft, VisiblePanelRight;\n    const panelExtensions = extensionManager.modules[MODULE_TYPES.PANEL];\n\n    panelExtensions.forEach(panelExt => {\n      panelExt.module.components.forEach(comp => {\n        if (comp.id === this.state.selectedRightSidePanel) {\n          VisiblePanelRight = comp.component;\n        } else if (comp.id === this.state.selectedLeftSidePanel) {\n          VisiblePanelLeft = comp.component;\n        }\n      });\n    });\n\n    console.log(\"Viewer render()\");\n    console.log(this.props.viewports);\n    console.log(this.props.activeViewportIndex);\n    console.log(this.props.studies);\n\n    return (\n      <>\n        {/* LAYOUT DIALOG */}\n        {this.state.isSelectingLayout &&\n          <LayoutPickerDialog\n            onCancel={() => {\n              this.setState({isSelectingLayout: false});\n            }}\n            onConfirm={result => {\n              this.setState({isSelectingLayout: false});\n              this.createNewStudy(result);\n            }}\n          />\n        }\n        {/* TOOLBAR */}\n        <ErrorBoundaryDialog context=\"ToolbarRow\">\n          <ToolbarRow\n            activeViewport={\n              this.props.viewports[this.props.activeViewportIndex]\n            }\n            isLeftSidePanelOpen={this.state.isLeftSidePanelOpen}\n            isRightSidePanelOpen={this.state.isRightSidePanelOpen}\n            selectedLeftSidePanel={\n              this.state.isLeftSidePanelOpen\n                ? this.state.selectedLeftSidePanel\n                : ''\n            }\n            selectedRightSidePanel={\n              this.state.isRightSidePanelOpen\n                ? this.state.selectedRightSidePanel\n                : ''\n            }\n            handleSidePanelChange={(side, selectedPanel) => {\n              const sideClicked = side && side[0].toUpperCase() + side.slice(1);\n              const openKey = `is${sideClicked}SidePanelOpen`;\n              const selectedKey = `selected${sideClicked}SidePanel`;\n              const updatedState = Object.assign({}, this.state);\n\n              const isOpen = updatedState[openKey];\n              const prevSelectedPanel = updatedState[selectedKey];\n              // RoundedButtonGroup returns `null` if selected button is clicked\n              const isSameSelectedPanel =\n                prevSelectedPanel === selectedPanel || selectedPanel === null;\n\n              updatedState[selectedKey] = selectedPanel || prevSelectedPanel;\n\n              const isClosedOrShouldClose = !isOpen || isSameSelectedPanel;\n              if (isClosedOrShouldClose) {\n                updatedState[openKey] = !updatedState[openKey];\n              }\n\n              this.setState(updatedState);\n            }}\n            handleMaximize={this.props.onMaximize}\n            handleNewStudy={() => { this.setState({isSelectingLayout: true}); }}\n            handleUpload={this.uploadImage.bind(this)}\n            studies={this.props.studies}\n            maximized={this.props.maximized}\n          />\n        </ErrorBoundaryDialog>\n\n        {/*<ConnectedStudyLoadingMonitor studies={this.props.studies} />*/}\n        {/*<StudyPrefetcher studies={this.props.studies} />*/}\n\n        {/* VIEWPORTS + SIDEPANELS */}\n        <div className=\"FlexboxLayout\">\n          {/* LEFT */}\n          <ErrorBoundaryDialog context=\"LeftSidePanel\">\n            <SidePanel from=\"left\" isOpen={this.state.isLeftSidePanelOpen}>\n              {VisiblePanelLeft ? (\n                <VisiblePanelLeft\n                  viewports={this.props.viewports}\n                  studies={this.props.studies}\n                  activeIndex={this.props.activeViewportIndex}\n                />\n              ) : (\n                <div>\n                  <ConnectedStudyBrowser\n                    studies={this.state.thumbnails}\n                    studyMetadata={this.props.studies}\n                  />\n                </div>\n              )}\n            </SidePanel>\n          </ErrorBoundaryDialog>\n\n          {/* MAIN */}\n          <div className={classNames('main-content')}>\n            {this.state.isSelectingLayout ?\n              <p>Please select layout...</p> :\n              <ErrorBoundaryDialog context=\"ViewerMain\">\n                <ConnectedViewerMain\n                  studies={this.props.studies}\n                  isStudyLoaded={this.props.isStudyLoaded}\n                />\n              </ErrorBoundaryDialog>\n            }\n          </div>\n\n          {/* RIGHT */}\n          <ErrorBoundaryDialog context=\"RightSidePanel\">\n            <SidePanel from=\"right\" isOpen={this.state.isRightSidePanelOpen}>\n              {VisiblePanelRight && (\n                <VisiblePanelRight\n                  isOpen={this.state.isRightSidePanelOpen}\n                  viewports={this.props.viewports}\n                  studies={this.props.studies}\n                  activeIndex={this.props.activeViewportIndex}\n                  activeViewport={\n                    this.props.viewports[this.props.activeViewportIndex]\n                  }\n                  getActiveViewport={this._getActiveViewport}\n                />\n              )}\n            </SidePanel>\n          </ErrorBoundaryDialog>\n        </div>\n      </>\n    );\n  }\n}\n\nexport default withDialog(Viewer);\n\n/**\n * What types are these? Why do we have \"mapping\" dropped in here instead of in\n * a mapping layer?\n *\n * TODO[react]:\n * - Add showStackLoadingProgressBar option\n *\n * @param {Study[]} studies\n * @param {DisplaySet[]} studies[].displaySets\n */\nconst _mapStudiesToThumbnails = function(studies) {\n  return studies.map(study => {\n    console.log(\"_mapStudiesToThumbnails\");\n    console.log(study);\n    const { StudyInstanceUID } = study;\n\n    const thumbnails = study.series.map(series => {\n      var displaySet = undefined\n      var numImageFrames = 1;\n      for (var i=0; i<study.displaySets.length; i++) {\n        const set = study.displaySets[i];\n        if (set.SeriesInstanceUID === series.SeriesInstanceUID) {\n          if (!displaySet) displaySet = set;\n          if (set.Maximized) numImageFrames = set.numImageFrames;\n        }\n      }\n\n      if (!displaySet) {\n        return null;\n      }\n\n      const {\n        displaySetInstanceUID,\n        SeriesDescription,\n        InstanceNumber,\n        SeriesInstanceUID,\n        SeriesNumber,\n      } = displaySet;\n\n      let imageId;\n      let altImageText;\n\n      if (displaySet.Modality && displaySet.Modality === 'SEG') {\n        // TODO: We want to replace this with a thumbnail showing\n        // the segmentation map on the image, but this is easier\n        // and better than what we have right now.\n        altImageText = 'SEG';\n      } else if (displaySet.images && displaySet.images.length) {\n        const imageIndex = Math.floor(displaySet.images.length / 2);\n\n        imageId = displaySet.images[imageIndex].getImageId();\n      } else {\n        altImageText = displaySet.Modality ? displaySet.Modality : '';\n      }\n\n      return {\n        imageId,\n        altImageText,\n        displaySetInstanceUID,\n        SeriesDescription,\n        InstanceNumber,\n        numImageFrames,\n        SeriesInstanceUID,\n        SeriesNumber,\n      };\n    }).filter(x => x);\n\n    return {\n      StudyInstanceUID,\n      thumbnails,\n    };\n  });\n};\n","import { connect } from 'react-redux';\nimport Viewer from './Viewer.js';\nimport OHIF from '@ohif/core';\n\nconst { setTimepoints, setMeasurements, maximize, setStudyData } = OHIF.redux.actions;\n\nconst getActiveServer = servers => {\n  const isActive = a => a.active === true;\n  return servers.servers.find(isActive);\n};\n\nconst mapStateToProps = state => {\n  const { viewports, servers } = state;\n  return {\n    viewports: viewports.viewportSpecificData,\n    activeViewportIndex: viewports.activeViewportIndex,\n    activeServer: getActiveServer(servers),\n    maximized: viewports.maximized\n  };\n};\n\nconst mapDispatchToProps = dispatch => {\n  return {\n    onTimepointsUpdated: timepoints => {\n      dispatch(setTimepoints(timepoints));\n    },\n    onMeasurementsUpdated: measurements => {\n      dispatch(setMeasurements(measurements));\n    },\n    onMaximize: () => {\n      dispatch(maximize());\n    },\n    onNewStudy: (layout) => {\n      dispatch(setStudyData(layout.StudyInstanceUID, layout));\n    }\n  };\n};\n\nconst ConnectedViewer = connect(\n  mapStateToProps,\n  mapDispatchToProps\n)(Viewer);\n\nexport default ConnectedViewer;\n"],"sourceRoot":""}